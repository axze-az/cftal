\documentclass[10pt,a4paper]{article}
\usepackage{amsmath}
\usepackage[utf8]{inputenc}
\usepackage{color}
\usepackage{listings}
\usepackage[bookmarks=true,hidelinks]{hyperref}
\numberwithin{equation}{subsection}

\lstset{
  % change this to 11 later
  language={C++},
  basicstyle=\footnotesize,
  keywordstyle=\bfseries\color{black},
  identifierstyle=\color{black}
}

\begin{document}
\title{cftal - yet another short vector library}
\author{axel zeuner}
\maketitle

\tableofcontents

\section{introduction}
\label{sec:introduction}

\section{base components}
\label{sec:base}

\section{vector math library}
\label{sec:vec_math_lib}

This section contains the description of the algorithms used in the
vector math library. The implemented algorithms are the same or
heavily based on the algorithms used in the sun math
library. Therefore the copyright of the sun libm source codes

\begin{verbatim}
/*
 * ====================================================
 * Copyright (C) 2004 by Sun Microsystems, Inc. All rights reserved.
 *
 * Permission to use, copy, modify, and distribute this
 * software is freely granted, provided that this notice
 * is preserved.
 * ====================================================
 */
\end{verbatim}
applies.

Functions for vector length from 1 to 8 are implemented as direct
instantiations of the template code in \texttt{include/cftal/math\_common.h}
using the macros in \texttt{src/vec\_def\_math\_functions.h}.
Functions for greater vector lengths are constructed like
\begin{lstlisting}
template <typename _T, std::size_t _N>
cftal::vec<_T, _N>
cftal::func(const vec<_T, _N>& x)
{
    vec<_T, _N> r= vec<_T, _N>(func(low_half(r)),
                               func(high_half(x)));
    return r;
}
\end{lstlisting}
recursively.

double argument identity for exponential functions:
\[
    \begin{aligned}
        (b^x-1)^2 &= b^{2x} - 2b^x + 1 \\
        b^{2x}    &= (b^x-1)^2 + 2b^x - 1 \\
        b^{2x} -1 &= (b^x-1)^2 + 2b^x -2 \\
                  &= (b^x-1)^2 + 2(b^x-1)
    \end{aligned}
\]


\subsection{basic functions: ldexp, frexp, ilogb}
\label{sub_sec:base_math}
\subsubsection{precision}
The functions have an error of $ \pm 0\, ulp$ compared against their glibc
counterparts

\subsection{exp}
\label{sub_sec:exp}
The function exp(x) calculates $ e^x $.

\subsubsection{precision}
The functions have an error of $ \pm 1\, ulp$.

\subsubsection{implementation}
\begin{itemize}
\item Argument reduction

    Reduce $x$ to $r$ so that $ |r| \le \frac{1}{2} log(2) $
    \begin{equation}
        x = k \times log(2) + r, \; |r| \le \frac{1}{2} log(2)
    \end{equation}
    $r$ is split into two values for calculation purposes
    \[
       \begin{aligned}
       r_h &= x - k \times LN2_{HI} \\
       r_l &= k \times LN2_{LO} \\
       r &= r_h - r_l
       \end{aligned}
    \]
    where $LN2_{HI}$ and $LN2_{LO}$ are Cody and Waite constants for $log(2)$.

\item Approximation of $e^r$ by a rational function on the interval
    $[0,\,\frac{1}{2}log(2)]$:

    as

    \begin{equation}
        \begin{aligned}
            e^{r} &= 1 + r + \frac{r^2}{2} + \frac{r^3}{6} + \dots \\
                  &\approx  1 + \frac {2r} {2 -r + r^2 P(r^2)} \\
        \end{aligned}
    \end{equation}

    To obtain higher precision the last equation is rewritten as
    \begin{equation}
        e^{r} \approx  1 + r + \frac{r [r -r^2 P(r^2)]} {2-[r-r^2P(r^2)]}
    \end{equation}

    Furthermore a correction term
    \[
        c = (r_h - r) - r_l
    \]
    is calculated.

    Using the taylor series of $e^{r+c}-1$ for $c \ll r$ and and truncating
    higher order terms
    \begin{equation}
        \label{equ:expm1-taylor}
        \begin{aligned}
            e^{r+c}-1 &= (e^r-1) + e^r\,c  + \frac{e^r c^2}{2} + \dots \\
                      &= (e^r-1) + e^r\,c  + \dots \\
                      &= (e^r-1) + (1+r+\frac{r^2}{2}+\dots)\,c + \dots \\
                      &= (e^r-1) + (c + r\,c + \dots) + \dots \\
                      &\approx (e^r-1) + c + r\,c
        \end{aligned}
    \end{equation}
    $e^{r+c}$ is calculated as
    \begin{equation}
        \begin{aligned}
            s &= \frac{r [r -r^2 P(r^2)]} {2-[r-r^2P(r^2)]} \\
            s &= s + r*c \\
            s &= s + c \\
            s &= s + r \\
            e^{r+c} &= s + 1
        \end{aligned}
    \end{equation}

    The order of the minimax polynomial $P(r^2)$ is 10 for double precision.

\item The function value of the reduced argument is scaled back using
    \begin{equation}
        e^x = 2^k \times e^r
    \end{equation}
    to obtain the result.

\end{itemize}


\subsection{expm1}
\label{sub_sec:expm1}
The function expm1(x) calculates $ e^x-1 $.

\subsubsection{precision}
The functions have an error of $ \pm 1\, ulp$.

\subsubsection{implementation}
\begin{itemize}
\item Argument reduction

    Reduce $x$ to $r$ so that $ |r| \le \frac{1}{2} log(2) $
    \begin{equation}
        x = k \times log(2) + r, \; |r| \le \frac{1}{2} log(2)
    \end{equation}
    $r$ is split into two values for calculation purposes
    \[
       \begin{aligned}
       r_h &= x - k \times LN2_{HI} \\
       r_l &= k \times LN2_{LO} \\
       r &= r_h - r_l
       \end{aligned}
    \]
    where $LN2_{HI}$ and $LN2_{LO}$ are Cody and Waite constants for $log(2)$.
    Furthermore a correction term
    \[
        c = (r_h - r) - r_l
    \]
    is calculated.

\item Approximation of $e^r-1$ by a special rational function on the interval
    $[0,\,\frac{1}{2}log(2)]$:
    \[
        r \frac{e^{r}+1}{e^{r}-1} =
        2+\frac{r^2}{6}-\frac{r^4}{360}+\cdots
    \]

\end{itemize}

\subsection{exp2}
The function exp2(x) calculates $ 2^x $.

\subsection{pow}
The function pow(x,y) calculates $ x^y $.

\subsubsection{precision}
The functions have an error of $ \pm x\, ulp$.

\subsubsection{implementation}
\begin{itemize}
\item argument reduction
    \begin{equation}
        \begin{aligned}
        x^y &= (2^{k_x} \times m_x) ^ {2^{k_y} \times m_y} \\
        log(x^y) &= y*log(x) \\
                 &= (2^{k_y} log(m_x) + log(2) k_x 2^{k_y}) m_y \\
                 &= (log(m_x) + log(2) k_x) 2^{k_y} m_y \\
        \end{aligned}
    \end{equation}
\end{itemize}

\subsection{cbrt}

\subsection{asinh}
\label{sub_sec:asin}
The function asin(x) calculates $ asinh(x) $.

\subsubsection{precision}
The functions have an error of $ \pm 2\, ulp$.

\subsubsection{implementation}
\begin{itemize}
\item Argument reduction
    \[
        \begin{aligned}
          asinh(x) &= log(x+\sqrt{1+x^2}) \\
                   &= log(x+\sqrt{1-x}\sqrt{1+x}) \\
          asinh(u) + asinh(v) &= asinh(u\sqrt{1+v^2} + v\sqrt{1+u^2}) \\
          asinh(x) + asinh(x) &= asinh(x\sqrt{1+x^2} + x\sqrt{1+x^2}) \\
                              &= asinh(2\,x\sqrt{1+x^2}) \\
          x &= 2^k\times r
        \end{aligned}
    \]
\end{itemize}

\end{document}
